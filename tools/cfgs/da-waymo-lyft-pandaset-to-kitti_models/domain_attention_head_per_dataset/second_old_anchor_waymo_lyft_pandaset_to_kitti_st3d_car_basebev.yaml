_BASE_CONFIG_: cfgs/da-waymo-lyft-pandaset-to-kitti_models/domain_attention_head_per_dataset/second_old_anchor_st3d_car_common.yaml

# CLASS_NAMES: ['Car']
# CLASS_NAMES: ['kitti:Car', 'waymo:Vehicle', 'lyft:car', 'pandaset:Car']
CLASS_NAMES: ['kitti:Car']
ONTOLOGY: 'kitti'

# Defined for build_model but not used for self training.
DATA_CONFIGS:
    WAYMO_CONFIG:
        _BASE_CONFIG_: cfgs/dataset_configs/da_waymo_dataset.yaml
        INFO_WITH_FAKELIDAR: False
        CLASS_NAMES: ['waymo:Vehicle']
        DRAW_CONF_CALIB_CURVE: False
        RUN_CONF_CALIB: False
    LYFT_CONFIG:
        _BASE_CONFIG_: cfgs/dataset_configs/da_lyft_dataset.yaml
        CLASS_NAMES: ['lyft:car']
        DRAW_CONF_CALIB_CURVE: False
        RUN_CONF_CALIB: False
    PANDASET_CONFIG:
        _BASE_CONFIG_: cfgs/dataset_configs/da_pandaset_dataset.yaml
        CLASS_NAMES: ['pandaset:Car']
        DRAW_CONF_CALIB_CURVE: False
        RUN_CONF_CALIB: False

# Used for self-training
DATA_CONFIG_TAR:
    _BASE_CONFIG_: cfgs/dataset_configs/da_kitti_dataset.yaml
    FOV_POINTS_ONLY: True
    CLASS_NAMES: ['kitti:Car']
    SHIFT_COOR: [0.0, 0.0, 1.6]
    DRAW_CONF_CALIB_CURVE: False
    RUN_CONF_CALIB: False

# Student model
MODEL:
    # _BASE_CONFIG_: cfgs/da-waymo-lyft-pandaset-to-kitti_models/naive/second_old_anchor_kitti_to_kitti.yaml
    NAME: SECONDNet

    VFE:
        NAME: MeanVFE

    BACKBONE_3D:
        NAME: VoxelBackBone8x

    MAP_TO_BEV:
        NAME: HeightCompression
        NUM_BEV_FEATURES: 256

    BACKBONE_2D:
        NAME: BaseBEVBackbone

        LAYER_NUMS: [5, 5]
        LAYER_STRIDES: [1, 2]
        NUM_FILTERS: [128, 256]
        UPSAMPLE_STRIDES: [1, 2]
        NUM_UPSAMPLE_FILTERS: [256, 256]

    DENSE_HEAD:
        NAME: AnchorHeadSingle
        CLASS_AGNOSTIC: False

        USE_DIRECTION_CLASSIFIER: True
        DIR_OFFSET: 0.78539
        DIR_LIMIT_OFFSET: 0.0
        NUM_DIR_BINS: 2

        ANCHOR_GENERATOR_CONFIG: [
            {
                'class_name': 'kitti:Car',
                'anchor_sizes': [[4.2, 2.0, 1.6]],
                'anchor_rotations': [0, 1.57],
                'anchor_bottom_heights': [0],
                'align_center': False,
                'feature_map_stride': 8,
                'matched_threshold': 0.55,
                'unmatched_threshold': 0.4
            }
        ]

        TARGET_ASSIGNER_CONFIG:
            NAME: AxisAlignedTargetAssigner
            POS_FRACTION: -1.0
            SAMPLE_SIZE: 512
            NORM_BY_NUM_EXAMPLES: False
            MATCH_HEIGHT: False
            BOX_CODER: ResidualCoder
            NUM_GT_ASSIGNMENT: 1

        LOSS_CONFIG:
            LOSS_WEIGHTS: {
                'cls_weight': 1.0,
                'loc_weight': 2.0,
                'dir_weight': 0.2,
                'code_weights': [1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0]
            }
            SCORE_WEIGHTING: True

    POST_PROCESSING:
        RECALL_THRESH_LIST: [0.3, 0.5, 0.7]
        SCORE_THRESH: 0.1
        OUTPUT_RAW_SCORE: False

        EVAL_METRIC: kitti

        NMS_CONFIG:
            MULTI_CLASSES_NMS: False
            NMS_TYPE: nms_gpu
            NMS_THRESH: 0.01
            NMS_PRE_MAXSIZE: 4096
            NMS_POST_MAXSIZE: 500

# Teacher model
SELF_TRAIN:
    MODEL_TEACHER:
        CLASS_NAMES: ['waymo:Vehicle', 'lyft:car', 'pandaset:Car']
        ONTOLOGY: 'head_per_dataset'

        # _BASE_CONFIG_: cfgs/da-waymo-lyft-pandaset-to-kitti_models/domain_attention_head_per_dataset/second_old_anchor_waymo_lyft_pandaset_to_kitti.yaml
        NAME: SECONDNet

        VFE:
            NAME: MeanVFE

        BACKBONE_3D:
            NAME: VoxelBackBone8x

        MAP_TO_BEV:
            NAME: HeightCompression
            NUM_BEV_FEATURES: 256

        BACKBONE_2D:
            NAME: DomainAttentionBEVBackbone
            # NAME: BaseBEVBackbone
            NUM_ADAPTERS: 3

            LAYER_NUMS: [5, 5]
            LAYER_STRIDES: [1, 2]
            NUM_FILTERS: [128, 256]
            UPSAMPLE_STRIDES: [1, 2]
            NUM_UPSAMPLE_FILTERS: [256, 256]

        DENSE_HEAD:
            NAME: AnchorHeadMulti
            CLASS_AGNOSTIC: False

            USE_DIRECTION_CLASSIFIER: True
            DIR_OFFSET: 0.78539
            DIR_LIMIT_OFFSET: 0.0
            NUM_DIR_BINS: 2

            USE_MULTIHEAD: True
            SEPARATE_MULTIHEAD: True
            ANCHOR_GENERATOR_CONFIG: [
                {
                    'class_name': 'waymo:Vehicle',
                    'anchor_sizes': [[4.2, 2.0, 1.6]],
                    'anchor_rotations': [0, 1.57],
                    'anchor_bottom_heights': [0],
                    'align_center': False,
                    'feature_map_stride': 8,
                    'matched_threshold': 0.55,
                    'unmatched_threshold': 0.4
                },
                {
                    'class_name': 'lyft:car',
                    'anchor_sizes': [[4.2, 2.0, 1.6]],
                    'anchor_rotations': [0, 1.57],
                    'anchor_bottom_heights': [0],
                    'align_center': False,
                    'feature_map_stride': 8,
                    'matched_threshold': 0.55,
                    'unmatched_threshold': 0.4
                },
                {
                    'class_name': 'pandaset:Car',
                    'anchor_sizes': [[4.2, 2.0, 1.6]],
                    'anchor_rotations': [0, 1.57],
                    'anchor_bottom_heights': [0],
                    'align_center': False,
                    'feature_map_stride': 8,
                    'matched_threshold': 0.55,
                    'unmatched_threshold': 0.4
                },
            ]
            SHARED_CONV_NUM_FILTER: null
            RPN_HEAD_CFGS: [
                {
                    'HEAD_CLS_NAME': ['waymo:Vehicle'],
                    'PLATT_SCALING_SCALE': [2.15252313],
                    'PLATT_SCALING_OFFSET': [7.51406276],
                },
                {
                    'HEAD_CLS_NAME': ['lyft:car'],
                    'PLATT_SCALING_SCALE': [1.94203519],
                    'PLATT_SCALING_OFFSET': [3.21289819],
                },
                {
                    'HEAD_CLS_NAME': ['pandaset:Car'],
                    'PLATT_SCALING_SCALE': [1.63204776],
                    'PLATT_SCALING_OFFSET': [3.71043937],
                },
            ]

            # SEPARATE_REG_CONFIG: 
            #     NUM_MIDDLE_CONV: 1
            #     NUM_MIDDLE_FILTER: 64
            #     REG_LIST: ['reg:2', 'height:1', 'size:3', 'angle:2']

            TARGET_ASSIGNER_CONFIG:
                NAME: AxisAlignedTargetAssigner
                POS_FRACTION: -1.0
                SAMPLE_SIZE: 512
                NORM_BY_NUM_EXAMPLES: False
                MATCH_HEIGHT: False
                BOX_CODER: ResidualCoder

            LOSS_CONFIG:
                LOSS_WEIGHTS: {
                    'cls_weight': 1.0,
                    'loc_weight': 2.0,
                    'dir_weight': 0.2,
                    'code_weights': [1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0]
                }
                SCORE_WEIGHTING: True

        POST_PROCESSING:
            RECALL_THRESH_LIST: [0.3, 0.5, 0.7]
            SCORE_THRESH: 0.0001
            OUTPUT_RAW_SCORE: False

            EVAL_METRIC: kitti

            NMS_CONFIG:
                MULTI_CLASSES_NMS: True
                NMS_TYPE: nms_gpu
                NMS_THRESH: 0.01
                NMS_PRE_MAXSIZE: 4096
                NMS_POST_MAXSIZE: 500

